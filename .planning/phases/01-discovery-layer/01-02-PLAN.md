---
phase: 01-discovery-layer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/main/lib/trpc/routers/workflows.ts, src/renderer/lib/trpc.ts]
autonomous: true
---

<objective>
Add dependency extraction to build the workflow graph linking agents, commands, skills, tools, and MCP servers.

Purpose: Transform raw agent/command/skill data into a dependency graph showing execution relationships.
Output: Enhanced workflows router with getWorkflowGraph procedure that returns the full dependency tree.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-discovery-layer/01-01-PLAN.md
@src/main/lib/trpc/routers/workflows.ts
@src/main/lib/trpc/routers/claude.ts
@src/main/lib/trpc/routers/claude-settings.ts
@src/renderer/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getWorkflowGraph procedure</name>
  <files>src/main/lib/trpc/routers/workflows.ts</files>
  <action>
Add a new procedure `getWorkflowGraph` to the workflows router that:

1. **Reads all agents, commands, skills** using helper functions from Task 01-01
2. **Builds dependency graph** by parsing the `tools` field from agent frontmatter:
   - Tools can be: Read, Grep, Glob, Edit, Write, Bash (built-in tools)
   - Or skill names (e.g., "frontend-ui-ux", "git-master")
   - Or MCP server references
   - Or agent/command calls (nested invocations)

3. **Returns hierarchical structure:**
```typescript
{
  agents: Array<{
    id: string
    name: string
    description: string
    model: string
    dependencies: {
      tools: string[]      // ["Read", "Grep", "Edit"]
      skills: string[]     // ["frontend-ui-ux"]
      mcpServers: string[] // ["filesystem-mcp"]
      agents: string[]     // ["codebase-analyzer"]
      commands: string[]   // ["commit"]
    }
    sourcePath: string
  }>
  commands: Array<{
    id: string
    name: string
    description: string
    // Commands don't have explicit dependencies in frontmatter
    sourcePath: string
  }>
  skills: Array<{
    id: string
    name: string
    description: string
    sourcePath: string
  }>
}
```

**Dependency parsing logic:**
- Built-in tools: Hardcoded list of Claude Code tools (Read, Write, Edit, Grep, Glob, Bash, etc.)
- Skills: Match against discovered skill names
- MCP: Detect patterns like "@mcp-" or server references in agent content
- Agent/Command calls: Scan agent body for patterns like "Use the {agent-name} agent" or Skill tool invocations

**File content reading:** For agents/commands that reference other agents or commands in their body (not just frontmatter), read the full file content and scan for invocation patterns.
  </action>
  <verify>
1. getWorkflowGraph procedure exists
2. Returns properly typed structure with agents, commands, skills
3. Dependencies arrays are populated for agents
4. TypeScript compiles
  </verify>
  <done>
getWorkflowGraph returns complete dependency graph for all workflow items
</done>
</task>

<task type="auto">
  <name>Task 2: Expose workflows router in renderer tRPC client</name>
  <files>src/renderer/lib/trpc.ts</files>
  <action>
Add the workflows router type to the renderer tRPC client so it can be used from React components.

Follow the existing pattern in trpc.ts - the router should be automatically available if the backend router is properly structured.

If manual type export is needed, add workflows to the type exports.
  </action>
  <verify>
1. trpc.workflows is accessible in renderer
2. TypeScript shows autocomplete for listAgents, listCommands, listSkills, getWorkflowGraph
3. bun run ts:check passes
  </verify>
  <done>
workflows router fully accessible from renderer via trpc.workflows
</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun run ts:check` passes without errors
- [ ] `bun run build` succeeds
- [ ] getWorkflowGraph returns properly structured dependency data
- [ ] All dependencies (tools, skills, MCP, agents, commands) extracted correctly
</verification>

<success_criteria>

- getWorkflowGraph procedure returns complete dependency graph
- Dependencies extracted from agent frontmatter `tools` field
- Nested agent/command calls detected in file bodies
- Router accessible from renderer
- All agents have their dependencies categorized by type
  </success_criteria>

<output>
After completion, create `.planning/phases/01-discovery-layer/01-02-SUMMARY.md`
</output>
